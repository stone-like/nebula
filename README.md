# Nebula

Go言語で書かれた自律型コーディングエージェントです。レイヤードアーキテクチャプロジェクトに新機能を追加したり、対話的に小さなプロジェクトを一から構築したりできます。

## 特徴

- **自律的なコード生成**: 最小限の指示で既存プロジェクトに新機能を追加
- **永続的メモリ**: SQLiteベースのセッション管理と会話履歴
- **動的モード切り替え**: PLAN（読み取り専用）とAGENT（完全実行）モードの切り替え
- **安全なファイル操作**: Read-Modify-Writeパターンとユーザー許可システム
- **マルチツールワークフロー**: 連続的なツール実行ループによる複雑な操作

## クイックスタート

### 前提条件

- Go 1.23.1以上
- OpenAI APIキー

### インストール

```bash
git clone <repository-url>
cd nebula
go mod tidy
```

### セットアップ

```bash
# OpenAI APIキーを設定
export OPENAI_API_KEY=your_api_key_here

# プロジェクトをビルド
go build -o nebula .

# CLIを実行
./nebula
```

## 使用方法

### 基本コマンド

対話型CLIでの操作：

- `model` - GPT-4.1-nano（デフォルト）とGPT-4.1-miniの切り替え
- `plan` - 読み取り専用の計画モードに切り替え
- `agent` - 完全実行モードに切り替え
- `mode` - 対話的なモード切り替え
- `exit` - アプリケーションを終了

### 開発ワークフロー

1. **計画から始める**: `plan`モードでコードベースを探索・理解
2. **実行に切り替え**: `agent`モードで変更を実装
3. **セッション継続**: 完全な会話履歴で前のセッションを再開

### 使用例

```bash
# エージェントを起動
./nebula

# 計画モードに切り替え
> plan

# 計画を相談
> "TODOアプリに優先度機能を追加したいのですが、どうすればいいでしょうか。計画を立ててみてください。"

# 実装のためにエージェントモードに切り替え
> agent

# 新機能を追加
> "それでは立てていただいた計画の通りにお願いします。"
```

## アーキテクチャ

### コアコンポーネント

- **main.go**: OpenAI統合とツールオーケストレーション機能付きCLIアプリケーション
- **config/**: 設定管理とモデル選択
- **memory/**: SQLiteバックエンドによる永続的メモリシステム
- **tools/**: ファイル操作用のモジュラーツールシステム

### ツールシステム

- `readFile`: UTF-8検証付きの完全ファイル内容読み取り
- `list`: 再帰オプション付きディレクトリリスト
- `searchInDirectory`: ファイル内の再帰的キーワード検索
- `writeFile`: ユーザー許可による新規ファイル作成
- `editFile`: Read-Modify-Writeパターンによる完全ファイル上書き

### 安全機能

- **ユーザー許可システム**: 破壊的操作には明示的な確認が必要
- **UTF-8検証**: すべてのファイル内容の適切なエンコーディング検証
- **Read-Modify-Writeパターン**: 安全なファイル編集の強制

## 設定

設定は`~/.nebula/config.json`に保存されます：

```json
{
  "model": "gpt-4.1-nano",
  "database_path": "~/.nebula/memory.db"
}
```

## 開発

### プロジェクト構造

```
nebula/
├── main.go              # CLIエントリポイント
├── config/              # 設定管理
│   └── config.go
├── memory/              # 永続的メモリシステム
│   ├── manager.go
│   ├── models.go
│   ├── database.go
│   └── queries.go
├── tools/               # モジュラーツールシステム
│   ├── common.go
│   ├── registry.go
│   ├── json_helpers.go
│   └── [ツール実装]
├── test/                # テストプロジェクト
│   └── todo-app/        # クリーンアーキテクチャの例
└── book/                # 章ベースのチュートリアル
```

### テスト

サンプルプロジェクトでエージェントをテスト。

```bash
# テストプロジェクトをコピー
cp -r test/todo-app ./todo-app
cd todo-app

# 変更追跡のためのgit初期化
git init && git add . && git commit -m "Initial state"

# エージェントでテスト
../nebula
```

### 一般的な開発コマンド

```bash
# ビルド
go build -o nebula .

# Goで直接実行
go run .

# 依存関係の更新
go mod tidy

# モジュールキャッシュのクリア
go clean -modcache
```

## 主要な設計原則

1. **情報収集優先**: 変更前に既存コードを常に分析
2. **安全な操作**: 破壊的アクションにはユーザー確認
3. **セッション継続**: セッション間での永続的メモリ
4. **モードベース安全性**: 計画と実行フェーズの分離
